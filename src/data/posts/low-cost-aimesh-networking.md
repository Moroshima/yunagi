# 低成本 AiMesh 组网小记

## 引言

家里之前一直都是在用 R6400 刷了梅林作为主路由在用，但受限于 R6400 逐渐过时的固件版本以及周边邻居路由器对 5GHz 频段的污染，我在自己房间隔了一道承重墙之后已经完全无法稳定连接到家中的主路由，因此我不得不在自己的房间增设了一台子路由，但并不是以 AC + AP 或 Mesh 组网的方式来去构建的网络结构，而是粗暴的直接怼上了一台 TC7102（也就是华为的 AX3）以 AP 模式运行。

虽然满血下移动设备测速能跑到 700-800Mbps 上下，但 AX3 羸弱的性能导致的不稳定的使用体验以及其与 Intel 网卡不那么优良的兼容性真是让我一言难尽。同时其覆盖范围不能完全覆盖我在家中的活动轨迹更是硬伤，一旦离我房间过远便会断连卡顿。但同时又因为还有微弱的信号足以维持连接，这就导致我的移动设备虽然在主路由的强信号覆盖范围之内，连接却并不会主动切换到主路由上去。还需要手动切换网络连接，割裂呜哇(╯°□°）╯︵ ┻━┻

于是，我便盯上了家用比较普遍的 Mesh 组网方案，但或许是因为大多是三频路由器的缘故，现在基于 WiFi6 的 Mesh 路由器价格都贵的离谱（

但同时我房间是有五类网线从主路由直通的，如果能使用有线 Mesh 的话岂不是双频路由器就能搞定了？加上我对 WiFi6 路由器也并不是强需求，在当年购入 R6400 时因为预算原因而被我 pass 掉的 AC68U 显然不失为一种高性价比的选择。

## 设备

我的方案使用的是 **ASUS RT-AC1900P + ASUS RT-AC68U**

从海鲜市场购入二手的话成本只需大概400米左右，性价比还是挺高的，并且后续如果想要继续拓展节点的话成本也并不会太高

▲交换机非必须设备，但可以解决 Mesh 组网导致的某些问题，文后会说明

## 网络拓扑

网络结构最大的变化就是用 Mesh 组网模式替代了原有的两个路由器独立工作的模式，此外通过修改桥接的方式把拨号与DHCP分配转移到了性能更为稳定可靠的主路由，同时还放通了公网 ipv6 连接。

原有网络拓扑

![image-20220701143424196](./assets/image-20220701143424196.png)

更新设备后的网络拓扑

![image-20220701143445997](./assets/image-20220701143445997.png)

网络结构最大的变化就是用 Mesh 组网模式替代了原有的两个路由器独立工作的模式，此外通过修改桥接的方式把拨号与DHCP分配转移到了性能更为稳定可靠的主路由，同时还放通了公网 ipv6 连接。

## 网络测试

IPv6 连通性测试 [IPv6 测试 (test-ipv6.com)](https://test-ipv6.com/index.html.zh_CN)

## 注意事项

### 如何将光猫修改为桥接模式

光猫桥接拨号运营商处应当可以远程修改，但如果直接要求其改桥接工作人员可能会不同意，但“中国人的性情是总喜欢调和，折中的”，如果你询问他索要光猫的超管账号与密码，他就会反诘你索要用途，此时工作人员会主动的帮你去修改光猫的桥接功能。

▲此外需要注意路由器改桥接并关闭 DHCP 服务器功能后一般情况下是无法直接通过IP再去访问光猫的，但同时 192.168.1.1 的地址还是会被光猫占用 [光猫改桥接后，无法进入管理后台 - V2EX](https://www.v2ex.com/t/815332) （文中有解决方案，但需要 OpenWrt 固件才能解决）

![image-20220701152313913](./assets/image-20220701152313913.png)

### 梅林固件可能导致的问题

按照部分旧版梅林固件用户的使用反馈来看，梅林固件可能会导致 AiMesh 功能无法正常识别节点设备与使用（我两台设备使用的都是 386.5_2 的固件，有线 Mesh 组网功能完全正常）

▲[RT-AC68U 梅林改版固件 - KoolCenter](https://www.koolcenter.com/posts/38) 提供的并非最新版本固件，最新版本固件（386.5_2）应从 [梅林改版固件 386.5_2 发布 by koolcenter - KoolCenter](https://www.koolcenter.com/posts/130) 下载，同时 386.7_0 的固件应该也会跟进支持 AC68U 系列。（固件列表 [KoolCenter 固件下载服务器](https://fw.koolcenter.com/KoolCenter_Merlin_New_Gen_386/RT-AC68U/)）

### AiMesh 搜索不到节点

在 AiMesh 添加节点（AiMesh node）时需要保证主路由处于搜索状态（点击添加 AiMesh 节点按钮并保持在弹出的搜索界面），同时子节点要被配置为 AiMesh node 状态并同样进入到搜索界面，这样才能保证主路由能够搜索到节点。

![image-20220701145152098](./assets/image-20220701145152098.png)

### 为什么子路由需要前置一个交换机连接其他设备

详细原因这篇文章做出了深入的分析 [请注意，华硕的MESH有线回程模式某些情况下传输带宽会减半 - 电脑讨论 - Chiphell - 分享与交流用户体验](https://www.chiphell.com/thread-2339520-1-1.html) 我选择子路由前置交换机连接其他设备的网络拓扑便是为了规避这一问题（因为我的有线连接设备很依赖满血带宽，特别是NAS）。但实际上无线连接至 AiMesh node 的设备依旧会存在此问题，此是为 Mesh 组网底层原理上的缺陷，无法避免，只能将其对其他终端网络设备的影响降到最小。

▲交换机是此前购入的，原本是因为华为路由器不知是否是包转发还是嵌套了一层华为自己的服务器加速的原因，似乎在访问某些网站时会出现问题（e.g.查看QQ动态时，无论无线有线，皆无法正常加载，但连接主路由 R6400时便不存在此问题）。交换机便是为了规避此问题同时正常将该路由器作为 AP 正常使用而购入的，因选择了不支持网管功能的型号

## 参考

- [MESH组网方案全集（有线回程，无线回程，AP模式，单线复用） - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/352135931)
- [什么是三频路由器？ | Answer | NETGEAR Support](https://kb.netgear.com/zh_CN/000060675/什么是三频路由器?language=zh_CN)
- [RT-AC68U Aimesh2.0组有线回程Mesh，老骥伏枥 路由器 什么值得买 (smzdm.com)](https://post.smzdm.com/p/a6lx4d7z/)
- [什么是有线回程和无线回程？ - 知乎 (zhihu.com)](https://www.zhihu.com/question/388374718)
- 有线回程模式传输带宽减半问题
  - [请注意，华硕的MESH有线回程模式某些情况下传输带宽会减半 - 电脑讨论 - Chiphell - 分享与交流用户体验](https://www.chiphell.com/thread-2339520-1-1.html)
  - [AC68U的AP模式Aimesh有线回程求教 - 电脑讨论 - Chiphell - 分享与交流用户体验](https://www.chiphell.com/thread-2307935-1-1.html)
  - [路由器ac68u局域网突然跑不满千兆了。。。 - 电脑讨论 - Chiphell - 分享与交流用户体验](https://www.chiphell.com/thread-2385868-1-1.html)
  - [AIMESH有线回程影响电脑LAN速度？？？ - 电脑讨论 - Chiphell - 分享与交流用户体验](https://www.chiphell.com/thread-2365222-1-1.html)
